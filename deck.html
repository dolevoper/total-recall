<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Total Recall</title>
    <link rel="stylesheet" href="dist/reset.css" />
    <link rel="stylesheet" href="dist/styles.css" />
    <link rel="stylesheet" href="dist/deck.css" />
</head>

<body>
    <main>
        <h1>Total Recall</h1>
        <a href="index.html">üè°Home</a>
        <h2>New Deck</h2>
        <form name="deckForm" class="deck-form">
            <div class="form-control">
                <label for="deckName">Name</label>
                <input id="deckName" name="deckName" required />
            </div>
            <h3>Cards</h3>
            <button id="btnAddCard" type="button">‚ûïAdd card</button>
            <ol id="cardList" class="card-list"></ol>
            <button type="submit">Save</button>
        </form>
    </main>

    <script type="module">
        import { upsertDeck } from "./dist/decks.model.js";
        import { upsertCard } from "./dist/cards.model.js";

        btnAddCard.addEventListener("click", function (e) {});

        document.forms.namedItem("deckForm").addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const name = formData.get("deckName");
            const cards = formData.getAll("cards").map((card) => JSON.parse(card));

            cards.forEach(upsertCard);

            upsertDeck({
                id: crypto.randomUUID(),
                name,
                cardIds: cards.map((card) => card.id)
            });

            window.location.replace("index.html");
        });

        btnAddCard.addEventListener("click", function (e) {
            const li = document.createElement("li");
            li.classList.add("card-list__item");

            const card = {
                id: crypto.randomUUID(),
                front: "",
                back: "",
                repetitions: 0,
                interval: 0,
                ef: 2.5
            };

            const cardInput = document.createElement("input");
            cardInput.type = "hidden";
            cardInput.name = "cards";
            cardInput.value = JSON.stringify(card);

            const frontTextarea = document.createElement("textarea");
            frontTextarea.id = `card-${card.id}-front`;
            frontTextarea.rows = 5;
            frontTextarea.addEventListener("input", function (e) {
                card.front = e.currentTarget.value;
                cardInput.value = JSON.stringify(card);
            });
            const frontLabel = document.createElement("label");
            frontLabel.htmlFor = frontTextarea.id;
            frontLabel.textContent = "Front";
            const frontContainer = document.createElement("div");
            frontContainer.classList.add("form-control");
            frontContainer.append(frontLabel, frontTextarea);
            
            const backTextarea = document.createElement("textarea");
            backTextarea.id = `card-${card.id}-back`;
            backTextarea.rows = 5;
            backTextarea.addEventListener("input", function (e) {
                card.back = e.currentTarget.value;
                cardInput.value = JSON.stringify(card);
            });
            const backLabel = document.createElement("label");
            backLabel.htmlFor = backTextarea.id;
            backLabel.textContent = "Back";
            const backContainer = document.createElement("div");
            backContainer.classList.add("form-control");
            backContainer.append(backLabel, backTextarea);
            
            li.append(cardInput, frontContainer, backContainer);
            cardList.append(li);

            frontTextarea.focus();
        });
    </script>
</body>

</html>